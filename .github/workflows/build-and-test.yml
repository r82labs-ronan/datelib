name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake clang-format
    
    - name: Configure CMake
      run: cmake -B build -S .
    
    - name: Check code formatting
      run: cmake --build build --target format-check

  build:
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential lcov

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON ..

    - name: Build
      run: |
        cd build
        cmake --build .

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/
        retention-days: 2

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: build/

    - name: Run tests
      run: |
        cd build
        # Make test executables executable (artifacts may lose permissions)
        chmod -R +x tests/ 2>/dev/null || true
        ctest --output-on-failure --verbose

    - name: Upload test artifacts with coverage data
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: build/
        retention-days: 2

  coverage:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install lcov
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov

    - name: Download test artifacts
      uses: actions/download-artifact@v4
      with:
        name: test-artifacts
        path: build/

    - name: Generate coverage report
      run: |
        cd build
        # Capture coverage data
        lcov --capture --directory . --output-file coverage.info

        # Remove system headers, test files, and Catch2 from coverage
        # --ignore-errors unused: Prevents errors when a removal pattern doesn't match any files
        # This is expected when build dependencies change or certain patterns are not present
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/_deps/*' --output-file coverage_filtered.info --ignore-errors unused

        # Verify filtered coverage file exists and is valid
        if [ ! -s coverage_filtered.info ]; then
          echo "ERROR: Coverage filtering produced empty or missing file"
          exit 1
        fi

        # Generate summary
        lcov --list coverage_filtered.info

        # Generate HTML report
        genhtml coverage_filtered.info --output-directory coverage_html --title "datelib Coverage Report" --legend

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/coverage_html/
        retention-days: 7

    - name: Check coverage threshold
      run: |
        cd build
        # Extract coverage percentage with validation
        # Expected format: "  lines......: 100.0% (2 of 2 lines)"
        COVERAGE_LINE=$(lcov --summary coverage_filtered.info 2>&1 | grep "^\s*lines")

        if [ -z "$COVERAGE_LINE" ]; then
          echo "ERROR: Could not find coverage summary in lcov output"
          exit 1
        fi

        COVERAGE=$(echo "$COVERAGE_LINE" | awk '{print $2}' | sed 's/%//')

        # Validate that COVERAGE is a valid number
        if ! [[ "$COVERAGE" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
          echo "ERROR: Extracted coverage value '$COVERAGE' is not a valid number"
          exit 1
        fi

        echo "Coverage: $COVERAGE%"

        # Check if coverage meets threshold using awk
        THRESHOLD=100
        CHECK=$(awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { if (cov < thr) print "FAIL"; else print "PASS" }')

        if [ "$CHECK" = "FAIL" ]; then
          echo "ERROR: Coverage is $COVERAGE%, which is below the required $THRESHOLD%"
          exit 1
        fi

        echo "SUCCESS: Coverage is $COVERAGE%, meeting the $THRESHOLD% requirement"
