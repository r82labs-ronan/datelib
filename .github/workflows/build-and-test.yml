name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential lcov
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake -DENABLE_COVERAGE=ON ..
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
    
    - name: Generate coverage report
      run: |
        cd build
        # Capture coverage data
        lcov --capture --directory . --output-file coverage.info
        
        # Remove system headers, test files, and Catch2 from coverage
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/_deps/*' --output-file coverage_filtered.info --ignore-errors unused
        
        # Generate summary
        lcov --list coverage_filtered.info
    
    - name: Check coverage threshold
      run: |
        cd build
        # Extract coverage percentage
        COVERAGE=$(lcov --summary coverage_filtered.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        
        # Check if coverage is 100% using awk
        THRESHOLD=100
        CHECK=$(awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { if (cov < thr) print "FAIL"; else print "PASS" }')
        
        if [ "$CHECK" = "FAIL" ]; then
          echo "ERROR: Coverage is $COVERAGE%, which is below the required $THRESHOLD%"
          exit 1
        fi
        
        echo "SUCCESS: Coverage is $COVERAGE%, meeting the $THRESHOLD% requirement"
